PROJECT(BlueLink)

CMAKE_MINIMUM_REQUIRED(VERSION 2.8)

## C++ options
#SET(CMAKE_CXX_STANDARD 11)
ADD_DEFINITIONS(-std=c++11)


## Unit tests
SET(TESTING ON CACHE BOOL "Build unit tests")
IF(TESTING)
	ENABLE_TESTING()
ENDIF()


## Modelsim setup
SET(VSIM_COMMAND "/usr/local/Altera/14.1/modelsim_ase/bin/vsim" CACHE PATH "path to vsim")
SET(VLOG_COMMAND "/usr/local/Altera/14.1/modelsim_ase/bin/vlog" CACHE PATH "path to vlog")
SET(VLIB_COMMAND "/usr/local/Altera/14.1/modelsim_ase/bin/vlib" CACHE PATH "path to vlib")

SET(VERILOG_TIMESCALE "1ns/1ps" CACHE STRING "Timescale directive for Verilog")

## Bluespec-specific options
SET(BLUESPEC_ASSIGNMENT_DELAY "#1" CACHE STRING "Assignment delay to set")
SET(BLUESPEC_USE_DEFAULT_PATH ON CACHE BOOL "Include default Bluespec path in -p option")
SET(BLUESPEC_DEFAULT_PATH "+" CACHE PATH "Include path for Bluespec")
SET(BLUESPEC_AGGRESSIVE_CONDITIONS ON CACHE BOOL "-aggressive-conditions switch")
SET(BLUESPEC_ASSERTIONS ON CACHE BOOL "-check-assert switch")
SET(BLUESPEC_VERILOG_OPTIONS "-opt-undetermined-vals -unspecified-to X" CACHE STRING "Verilog synthesis options")

IF(BLUESPEC_AGGRESSIVE_CONDITONS)
	SET (BLUESPEC_COMPILE_OPTIONS "${BLUESPEC_COMPILE_OPTIONS} -aggressive-conditions")
ENDIF()

IF(BLUESPEC_ASSERTIONS)
	SET(BLUESPEC_COMPILE_OPTIONS "${BLUESPEC_COMPILE_OPTIONS} -check-assert")
ENDIF()

IF(BLUESPEC_DEFAULT_PATH)
	SET(BLUESPEC_PATH "${BLUESPEC_DEFAULT_PATH}")
ENDIF()

IF(BLUESPEC_ASSIGNMENT_DELAY)
	SET(BLUESPEC_ASSIGNMENT_DELAY_ARG "+define+BSV_ASSIGNMENT_DELAY=${BLUESPEC_ASSIGNMENT_DELAY}")
ENDIF()

## Bluespec IP compilation
FILE(GLOB bluespecIP_SRC "$ENV{BLUESPECDIR}/Verilog/*.v")
EXECUTE_PROCESS(
	COMMAND ${VLOG_COMMAND} -work work ${bluespecIP_SRC} -l bluespec.v.log -timescale ${VERILOG_TIMESCALE} ${BLUESPEC_ASSIGNMENT_DELAY_ARG} ${bluespecIP_SRC}
	WORKING_DIRECTORY ${CMAKE_BINARY_DIR})

## Adds a compilation target for ${FN}.bsv and a target named ${FN}
FUNCTION(ADD_BSV_PACKAGE PACKAGE)

	ADD_CUSTOM_COMMAND(
		OUTPUT ${CMAKE_BINARY_DIR}/${PACKAGE}.bo
		COMMAND bsc ${BLUESPEC_COMPILE_OPTS} -p ${BLUESPEC_PATH} -bdir ${CMAKE_BINARY_DIR} ${CMAKE_CURRENT_SOURCE_DIR}/${PACKAGE}.bsv
		DEPENDS ${PACKAGE}.bsv
		)

	ADD_CUSTOM_TARGET(${PACKAGE} DEPENDS ${CMAKE_BINARY_DIR}/${PACKAGE}.bo)
ENDFUNCTION()

EXECUTE_PROCESS(COMMAND ${VLIB_COMMAND} work
	WORKING_DIRECTORY ${CMAKE_BINARY_DIR})

## Adds a testbench file from the named package
FUNCTION(ADD_BSV_TESTBENCH PACKAGE)
	ADD_BSV_PACKAGE(${PACKAGE})
ENDFUNCTION()

## Adds a testcase from a previously-added testbench package
FUNCTION(ADD_BSV_TESTCASE PACKAGE TESTCASE)
	ADD_CUSTOM_COMMAND(
		OUTPUT ${CMAKE_BINARY_DIR}/test_${TESTCASE}
		COMMAND bsc -sim ${BLUESPEC_COMPILE_OPTS} -g mkTB_${TESTCASE} -bdir ${CMAKE_BINARY_DIR} ${CMAKE_CURRENT_SOURCE_DIR}/${PACKAGE}.bsv 
		COMMAND bsc -sim ${BLUESPEC_COMPILE_OPTS} -e mkTB_${TESTCASE} -bdir ${CMAKE_BINARY_DIR} -o ${CMAKE_BINARY_DIR}/test_${TESTCASE}
		DEPENDS ${CMAKE_BINARY_DIR}/${PACKAGE}.bo)

#		ADD_TEST("BSV_${PACKAGE}_${TESTCASE}" ${CMAKE_BINARY_DIR}/test_${TESTCASE})

	ADD_CUSTOM_TARGET(${TESTCASE} DEPENDS ${PACKAGE} ${CMAKE_BINARY_DIR}/test_${TESTCASE})
ENDFUNCTION()

#FUNCTION(ADD_VERILOG_SOURCE)
#	ADD_CUSTOM_COMMAND(a
#
#vlog -work <lib> -l <logfile> -timescale 1ns/1ps
#ENDFUNCTION()


FUNCTION(ADD_VERILOG_TESTCASE PACKAGE TESTCASE)
	FILE(MAKE_DIRECTORY ${CMAKE_CURRENT_BINARY_DIR}/VerilogTest)
	ADD_CUSTOM_COMMAND(
		OUTPUT ${CMAKE_CURRENT_BINARY_DIR}/VerilogTest/mkTB_${TESTCASE}.v ${CMAKE_CURRENT_BINARY_DIR}/VerilogTest/mkTB_${TESTCASE}.v.log
		COMMAND bsc -verilog ${BLUESPEC_COMPILE_OPTS} -g mkTB_${TESTCASE} -bdir ${CMAKE_BINARY_DIR} -vdir ${CMAKE_CURRENT_BINARY_DIR}/VerilogTest ${CMAKE_CURRENT_SOURCE_DIR}/${PACKAGE}.bsv
		COMMAND ${VLOG_COMMAND} -work work -l ${CMAKE_CURRENT_BINARY_DIR}/VerilogTest/mkTB_${TESTCASE}.v.log -timescale ${VERILOG_TIMESCALE} ${BLUESPEC_ASSIGNMENT_DELAY_ARG} ${CMAKE_CURRENT_BINARY_DIR}/VerilogTest/mkTB_${TESTCASE}.v
		WORKING_DIRECTORY ${CMAKE_BINARY_DIR}
# Creates the Modelsim script
#		COMMAND bsc -verilog ${BLUESPEC_COMPILE_OPTS} -e mkTB_${TESTCASE}
		DEPENDS ${CMAKE_BINARY_DIR}/${PACKAGE}.bo)

	ADD_TEST(NAME "BSV|${PACKAGE}:mkTB_${TESTCASE}.v"
		COMMAND ${VSIM_COMMAND} -c -do "force CLK -drive 1'b0, 1'b1 @ 2 -repeat 4; force RST_N -drive 1'b0, 1'b1 @ 4; run -all" -t 1ns -lib work -onfinish exit -L altera_mf_ver work.mkTB_${TESTCASE}
		WORKING_DIRECTORY ${CMAKE_BINARY_DIR})
#${VSIM_LIBS})

# vsim -c -do "command" -gGenericName=Value -l logfile -lib <work> -onfinish exit -L <libs> -pli
# -quiet -> suppress loading messages

	ADD_CUSTOM_TARGET(Test_Verilog_${TESTCASE} DEPENDS ${PACKAGE} ${CMAKE_CURRENT_BINARY_DIR}/VerilogTest/mkTB_${TESTCASE}.v)
ENDFUNCTION()

FUNCTION(ADD_VERILOG_TESTBENCH FN TESTCASE)
ENDFUNCTION()

FUNCTION(ADD_VERILOG_SOURCE FNPFX LIB)
	ADD_CUSTOM_COMMAND(
		OUTPUT ${CMAKE_CURRENT_BINARY_DIR}/${FNPFX}.v.log
		COMMAND ${VLOG_COMMAND} -work work -l ${CMAKE_CURRENT_BINARY_DIR}/${FNPFX}.v.log -timescale ${VERILOG_TIMESCALE} ${BLUESPEC_ASSIGNMENT_DELAY_ARG} ${CMAKE_CURRENT_SOURCE_DIR}/${FNPFX}.v
		WORKING_DIRECTORY ${CMAKE_BINARY_DIR}
		DEPENDS ${FNPFX}.v)

	ADD_CUSTOM_TARGET(${FNPFX} DEPENDS ${CMAKE_CURRENT_BINARY_DIR}/${FNPFX}.v.log)
ENDFUNCTION()

ADD_SUBDIRECTORY(Altera)
ADD_SUBDIRECTORY(MemScanChain)
